@page "/login"
@inject ApiClientService ApiClient
@inject SessionStateService SessionState
@inject NavigationManager NavigationManager
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@rendermode InteractiveServer

<h3>Login</h3>

<EditForm Model="loginModel" OnValidSubmit="HandleLogin" @ref="loginForm" FormName="LoginForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label for="email">Email:</label>
        <InputText id="email" @bind-Value="loginModel.Email" />
    </div>
    <div>
        <label for="password">Password:</label>
        <InputText id="password" @bind-Value="loginModel.Password" type="password" />
    </div>

    <button type="submit">Login</button>
</EditForm>

@code {
    private LoginModel loginModel = new LoginModel();
    private bool loginSuccessful = false;

    private EditForm loginForm;

    private async Task HandleLogin()
    {
        Console.WriteLine("Going to send: " + loginModel.Email + " " + loginModel.Password);

        try
        {
            var result = await ApiClient.PostAsync<LoginResponse>("/auth/login", loginModel);

            if (result?.Token?.Result != null)
            {
                // Store the token and user info in SessionState
                SessionState.UserToken = result.Token.Result;
                SessionState.UserId = result.UserId;

                // Mark login as successful to trigger navigation
                loginSuccessful = true;

                NavigationManager.NavigateTo("/");
            }
            else
            {
                // Handle case where token is null
                Console.WriteLine("Error: Token not found in response");
            }
        }
        catch (Exception ex)
        {
            if (ex is NavigationException)
            {
                throw ex;
            }
            // Log the exception for further debugging
            Console.WriteLine($"Error during login: {ex.Message}");
        }
    }

    public class LoginModel
    {
        public string Email { get; set; }
        public string Password { get; set; }
    }

    public class TokenResult
    {
        public string Result { get; set; }
    }

    public class LoginResponse
    {
        public TokenResult Token { get; set; }
        public string UserId { get; set; }
        public string Email { get; set; }
    }
}
